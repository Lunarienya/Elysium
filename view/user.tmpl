{{ template "layout" . }}

{{ define "title" }}{{ .TargetUser.Username }}'s Account - {{ .App.Config.ApplicationName }}{{ end }}

{{ define "content" }}
  <h1 class="text-center font-bold text-xl">{{ .TargetUser.Username }}</h1>

  <div style="display: none">
    {{ range $player := .TargetUser.Players }}
      <form
        id="delete-{{ $player.UUID }}"
        action="{{ $.App.FrontEndURL }}/web/delete-player"
        method="post"
        onsubmit="return confirm('Are you sure you want to delete {{ $player.Name }}? This action is irreversible.');"
      >
        <input name="returnUrl" value="{{ $.URL }}" />
        <input name="uuid" value="{{ $player.UUID }}" />
      </form>
    {{ end }}
  </div>

  <div style="display: none">
    {{ range $providerName := .LinkedOIDCProviderNames }}
      <form
        id="unlink-{{ $providerName }}"
        action="{{ $.App.FrontEndURL }}/web/oidc-unlink"
        method="post"
        onsubmit="return confirm('Are you sure you want to unlink your {{ $providerName }} account? You will no longer be able to log in to your {{ $.App.Config.ApplicationName }} account using {{ $providerName }}.');"
      >
        <input name="returnUrl" value="{{ $.URL }}" />
        <input name="userUuid" value="{{ $.TargetUser.UUID }}" />
        <input name="providerName" value="{{ $providerName }}" />
      </form>
    {{ end }}
  </div>

  <h3>{{ if .AdminView }}{{ .TargetUser.Username }}'s{{ else }}Your{{ end }} Minecraft Player</h3>
  {{ if .TargetUser.Players }}
    <table>
      <tbody>
        {{ range $player := .TargetUser.Players }}
          <tr>
            <td style="width: 30px">
              <div
                class="list-profile-picture"
                {{ with $playerSkinURL := PlayerSkinURL $player }}
                  {{ if $playerSkinURL }}
                    style="background-image: url({{ $playerSkinURL }});"
                  {{ end }}
                {{ end }}
              ></div>
            </td>
            <td>
              <a
                href="{{ $.App.FrontEndURL }}/web/player/{{ $player.UUID }}"
                >{{ $player.Name }}</a
              >
            </td>
            <td>{{ $player.UUID }}</td>
            {{ if or $.App.Config.AllowAddingDeletingPlayers $.User.IsAdmin }}
              <td>
                <input type="submit" form="delete-{{ $player.UUID }}" value="Delete" />
              </td>
            {{ end }}
          </tr>
        {{ end }}
      </tbody>
    </table>
  {{ else }}
    No players yet.
  {{ end }}
  <p>
    {{ if or (and (not .User.IsAdmin) (not .App.Config.AllowAddingDeletingPlayers)) (eq .MaxPlayerCount 0) }}
      {{ if .AdminView }}{{ .TargetUser.Username }} is{{ else }}You are{{ end }} not allowed to create new players.
      {{ if .AdminView }}You can override this limit since you're an admin.{{ end }}
    {{ else if (gt .MaxPlayerCount 0) }}
      {{ if .AdminView }}{{ .TargetUser.Username }}'s{{ else }}Your{{ end }} account can have up to {{ .MaxPlayerCount }} player(s).
      {{ if .AdminView }}You can override this limit since you're an admin.{{ end }}
    {{ else }}
      {{ if .AdminView }}{{ .TargetUser.Username }}'s{{ else }}Your{{ end }} account can have an unlimited number of players.
    {{ end }}
  </p>
  {{ if or (and .App.Config.AllowAddingDeletingPlayers (or (lt (len .TargetUser.Players) .MaxPlayerCount) (lt .MaxPlayerCount 0))) .User.IsAdmin }}
    {{ if .App.Config.CreateNewPlayer.Allow }}
      {{ if or .User.IsAdmin .App.Config.CreateNewPlayer.AllowChoosingUUID }}
        <h4>Create a new player</h4>
      {{ else }}
        <p>Create a new player with a random UUID:</p>
      {{ end }}
      <form action="{{ .App.FrontEndURL }}/web/create-player" method="post">
        <input hidden name="userUuid" value="{{ .TargetUser.UUID }}">
        <input
          type="text"
          name="playerName"
          placeholder="Player name"
          maxlength="{{ .App.Constants.MaxPlayerNameLength }}"
          required
        />
        {{ if or .User.IsAdmin .App.Config.CreateNewPlayer.AllowChoosingUUID }}
          <input
            class="long"
            type="text"
            name="playerUuid"
            placeholder="Player UUID (leave blank for random)"
            pattern="^[0-9a-f]{8}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{12}$"
          />
        {{ end }}
        <input hidden name="returnUrl" value="{{ .URL }}" />
        <input type="submit" value="Create player" />
      </form>
    {{ end }}
    {{ if .App.Config.ImportExistingPlayer.Allow }}
      <h4>Import a(n) {{ .App.Config.ImportExistingPlayer.Nickname }} player</h4>
      {{ if .App.Config.ImportExistingPlayer.RequireSkinVerification }}
        <p>
          Create a new player with the UUID of an existing
          {{ .App.Config.ImportExistingPlayer.Nickname }} player.
          Requires verification that you own the account.
        </p>
        <form action="{{ .App.FrontEndURL }}/web/create-player-challenge" method="get">
          <input
            type="text"
            name="playerName"
            placeholder="{{ .App.Config.ImportExistingPlayer.Nickname }} player name"
            maxlength="{{ .App.Constants.MaxUsernameLength }}"
            required
          />
          <input hidden name="userUuid" value="{{ .TargetUser.UUID }}">
          <input hidden name="returnUrl" value="{{ .URL }}" />
          <input type="submit" value="Continue" />
        </form>
      {{ else }}
        <p>
          Create a new player with the UUID of an existing
          {{ .App.Config.ImportExistingPlayer.Nickname }} player.
        </p>
        <form action="{{ .App.FrontEndURL }}/web/create-player" method="post">
          <input
            type="text"
            name="playerName"
            placeholder="{{ .App.Config.ImportExistingPlayer.Nickname }} Player name"
            maxlength="{{ .App.Constants.MaxPlayerNameLength }}"
            required
          />
          <input hidden type="checkbox" name="existingPlayer" checked />
          <input hidden name="userUuid" value="{{ .TargetUser.UUID }}">
          <input hidden name="returnUrl" value="{{ .URL }}" />
          <input type="submit" value="Create player" />
        </form>
      {{ end }}
    {{ end }}
  {{ end }}

  {{ if gt (len .App.OIDCProvidersByName) 0 }}
    <h3>Linked accounts</h3>
    {{ if gt (len $.LinkedOIDCProviderNames) 0 }}
      <p>
        These external accounts are linked to {{ if .AdminView }}{{ .TargetUser.Username }}'s{{ else }}your{{ end }} {{ .App.Config.ApplicationName }} account:
      </p>
      <table>
        <tbody>
          {{ range $providerName := $.LinkedOIDCProviderNames }}
            <tr>
              <td>{{ $providerName }}</td>
              <td>
                <input
                  type="submit"
                  form="unlink-{{ $providerName }}"
                  value="Remove"
                  {{ if le (len $.LinkedOIDCProviderNames) 1 }}disabled title="Can't remove the last linked OIDC account."{{ end }}
                />
              </td>
            </tr>
          {{ end }}
        </tbody>
      </table>
    {{ else }}
      <p>
        Astrality is not linked to {{ if .AdminView }}{{ .TargetUser.Username }}'s{{ else }}your{{ end }} {{ .App.Config.ApplicationName }} account. <span class="warning-message">If you link with an Astrality account, you will no longer be able to log in using your {{ .App.Config.ApplicationName }} password. You'll need to use your Minecraft Token to log in to Elysium Launcher.</span>
      </p>
    {{ end }}
    {{ if and (eq .User.UUID .TargetUser.UUID) (gt (len $.UnlinkedOIDCProviders) 0) }}
      {{ range $provider := $.UnlinkedOIDCProviders }}
          <p>
            <a href="{{ $provider.AuthURL }}">Link with {{ $provider.Name }}</a></td>
          </p>
      {{ end }}
    {{ end }}
  {{ end }}

  <h3 class="font-bold text-2xl">Elysium Account settings</h3>
  <form action="{{ .App.FrontEndURL }}/web/update-user" method="post" enctype="multipart/form-data">
    {{ if and .User.IsAdmin (not .TargetUser.IsAdmin) }}
      <p>
          <label for="max-player-count">Max number of players</label><br>
          <small>Specify -1 to allow unlimited players or leave blank to reset to the configured default value.</small><br>
          <input
            name="maxPlayerCount"
            type="number"
            {{ if .TargetUser.IsAdmin }}disabled{{ end }}
            value="{{ if or .TargetUser.IsAdmin (eq .TargetUser.MaxPlayerCount $.App.Constants.MaxPlayerCountUnlimited) }}-1{{ else if eq .TargetUser.MaxPlayerCount $.App.Constants.MaxPlayerCountUseDefault}}{{ else }}{{ .TargetUser.MaxPlayerCount }}{{ end }}"
            placeholder="{{ .App.Config.DefaultMaxPlayerCount }}"
            min="-1">
          </input>
      </p>
    {{ end }}
    {{ if and .App.Config.AllowPasswordLogin (eq (len $.LinkedOIDCProviderNames) 0) }}
      <p>
        <label for="password">Password</label><br />
        <input type="password" name="password" id="password" class="bg-neutral-800 px-4 py-2 rounded" placeholder="Leave blank to keep" />
      </p>
    {{ end }}
    <p>
      <label for="minecraftToken">Minecraft Token</label><br>
      <small>Can be used instead of a password to sign in to Minecraft launchers.</small><br>
      <input type="text" name="minecraftToken" id="minecraft-token" class="bg-neutral-800 px-4 py-2 rounded" readonly value="{{ .TargetUser.MinecraftToken }}" />
      <br>
      <label for="reset-minecraft-token"> check the box to reset your Minecraft token
      </label>
      <input type="checkbox" name="resetMinecraftToken" id="reset-minecraft-token" />
    </p>
    <p>
      <label for="preferred-language">Preferred Language (used by Minecraft)</label><br />
      <select name="preferredLanguage" id="preferred-language" value="{{ .TargetUser.PreferredLanguage }}"></select>
    </p>
    <input hidden name="uuid" value="{{ .TargetUser.UUID }}" />
    <input hidden name="returnUrl" value="{{ .URL }}" />
    <input class="bg-violet-500 rounded px-4 py-2 text-base text-white hover:enabled:bg-primary/90 flex gap-2 items-center justify-center transition-all active:enabled:scale-[98%] disabled:opacity-50 disabled:cursor-not-allowed" type="submit" value="Save changes" />
  </form>
  <p>
    <form action="{{ .App.FrontEndURL }}/web/delete-user" method="post" onsubmit="return confirm('Are you sure? This action is irreversible.');">
      <input hidden name="uuid" value="{{ .TargetUser.UUID }}" />
      <input hidden name="returnUrl" value="{{ if .AdminView }}
          {{ .App.FrontEndURL }}/web/admin
        {{ else }}
          {{ .App.FrontEndURL }}
        {{ end }}"
      />
      <input type="submit" class="bg-red-500 rounded px-4 py-2 text-base text-white hover:enabled:bg-primary/90 flex gap-2 items-center justify-center transition-all active:enabled:scale-[98%] disabled:opacity-50 disabled:cursor-not-allowed" value="Delete Account" />
      </form>
  </p>

  {{ template "footer" . }}

{{ end }}
